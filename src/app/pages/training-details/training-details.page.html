<ion-header translucent="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/tab1"></ion-back-button>
    </ion-buttons>
    <ion-title>Entrenamiento</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="td-shell">

    <!-- Loading -->
    <div class="td-loading" *ngIf="loading">
      <ion-spinner name="crescent"></ion-spinner>
      <div class="td-loading-text">Cargando entrenamiento…</div>
    </div>

    <!-- Content (sin alias tipo "as d") -->
    <ng-container *ngIf="!loading && detail">

      <!-- HERO CARD -->
      <section class="td-card td-hero">
        <div class="td-cover">
          <img
            class="td-cover-img"
            [src]="detail.training_session?.cover_image || fallbackCover"
            alt="Cover"
            (error)="onImgError($event)"
          />
          <div class="td-cover-overlay"></div>
        </div>

        <div class="td-hero-body">
          <div class="td-badges">
           <span class="td-badge"
              [class.is-live]="detail.status === 'in_progress'"
              [class.is-done]="detail.status === 'completed'">
                {{
                  detail.status === 'completed'
                    ? 'COMPLETADO'
                    : (detail.status === 'in_progress' ? 'EN PROGRESO' : 'ASIGNADO')
                }}
          </span>

            <span class="td-badge is-soft" *ngIf="detail.scheduled_for">
              {{ detail.scheduled_for }}
            </span>
          </div>

          <h1 class="td-title">{{ detail.training_session.title }}</h1>

          <div class="td-meta">
            <div class="td-meta-item">
              <ion-icon name="time-outline"></ion-icon>
              <span>{{ detail.training_session.duration_minutes ?? 0 }} mins</span>
            </div>

            <div class="td-meta-item">
              <ion-icon name="barbell-outline"></ion-icon>
              <span>{{ detail.training_session.level }}</span>
            </div>

            <div class="td-meta-item" *ngIf="detail.training_session.goal">
              <ion-icon name="flash-outline"></ion-icon>
              <span>{{ detail.training_session.goal }}</span>
            </div>

            <div class="td-meta-item" *ngIf="detail.training_session.type">
              <ion-icon name="fitness-outline"></ion-icon>
              <span>{{ detail.training_session.type }}</span>
            </div>
          </div>

          <p class="td-notes" *ngIf="detail.training_session.notes">
            {{ detail.training_session.notes }}
          </p>

          <!-- Progress -->
          <div class="td-progress">
            <div class="td-progress-row">
              <div class="td-progress-label">Progreso</div>
              <div class="td-progress-value">{{ detail.progress.pct }}%</div>
            </div>

            <div class="td-progress-bar">
              <div class="td-progress-fill" [style.width.%]="detail.progress.pct"></div>
            </div>

            <div class="td-progress-sub">
              {{ detail.progress.sections_completed }} / {{ detail.progress.sections_total }} secciones completadas
            </div>
          </div>
        </div>
      </section>

      <!-- SECTIONS -->
      <section class="td-section">
        <div class="td-section-header">
          <h2 class="td-section-title">Secciones</h2>
          <span class="td-section-sub">{{ detail.sections.length }} items</span>
        </div>

        <div class="td-list">
          <article
            class="td-card td-item"
            *ngFor="let section of detail.sections; trackBy: trackBySectionId"
          >
            <div class="td-item-head">
              <div class="td-item-left">
                <div class="td-order">#{{ section.order }}</div>
                <div class="td-item-title">{{ section.name }}</div>
              </div>

              <div class="td-item-right">
                <span class="td-chip" [class.is-done]="section.completed">
                  {{ section.completed ? 'Hecho' : 'Pendiente' }}
                </span>
              </div>
            </div>

            <p class="td-item-desc" *ngIf="section.description">
              {{ section.description }}
            </p>

            <!-- Video (solo si existe) -->
            <div class="td-video" *ngIf="section.video_url">
              <iframe
                [src]="youtubeEmbedUrl(section.video_url)"
                title="Video"
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen>
              </iframe>
            </div>

            <!-- Result -->
<div class="td-result" *ngIf="section.result; else noResult">
  <div class="td-result-main">
    <div class="td-result-value">{{ section.result.value }}</div>

    <!-- 1) unit desde el resultado (si viene) -->
    <div class="td-result-unit" *ngIf="section.result.unit">
      {{ section.result.unit }}
    </div>

    <!-- 2) fallback: unit desde la sección -->
    <div class="td-result-unit" *ngIf="!section.result.unit && section.unit">
      {{ section.unit }}
    </div>

    <!-- 3) último fallback: tipo -->
    <div class="td-result-unit" *ngIf="!section.result.unit && !section.unit && section.result_type">
      {{ section.result_type }}
    </div>
  </div>

  <div class="td-result-notes" *ngIf="section.result.notes">
    {{ section.result.notes }}
  </div>

  <div class="td-result-date">
    {{ section.result.recorded_at | date:'medium' }}
  </div>
</div>

<ng-template #noResult>
  <div class="td-empty-inline">
    <span>Sin resultado aún</span>
  </div>
</ng-template>


            <!-- Actions -->
  <div class="td-item-actions">
              <!-- Registrar resultado: SOLO si acepta resultados -->
<button
  class="td-link"
  type="button"
  *ngIf="section.accepts_results && !section.result"
  (click)="onAddResult(section)"
>
  Registrar resultado
</button>



  <!-- Editar (solo si YA hay resultado) -->
<button
  class="td-link"
  type="button"
  *ngIf="section.accepts_results && section.result"
  (click)="onEditResult(section)"
>
  Editar resultado
</button>

              <!-- Expanded inline form (solo si acepta resultados y es la sección expandida) -->
<div
  class="td-inline-form"
  *ngIf="section.accepts_results && expandedSectionId === section.id"
  (click)="$event.stopPropagation()"
>
  <div class="td-form-group">
    <label class="td-form-label">
      Resultado
      <span class="td-form-hint" *ngIf="section.result_type">  ({{ section.unit || section.result_type }})</span>
    </label>

    <input
      class="td-form-input"
      type="text"
      [(ngModel)]="editingResultValue"
      [ngModelOptions]="{ standalone: true }"

      placeholder="Ej: 100 / 12:30 / completado…"
    />
  </div>

  <div class="td-form-group">
    <label class="td-form-label">Notas (opcional)</label>
    <textarea
    class="td-textarea"
    rows="2"
    [(ngModel)]="editingResultNotes"
    [ngModelOptions]="{ standalone: true }"
    placeholder="Agrega comentarios..."
  ></textarea>

  </div>

  <div class="td-form-actions">
    <button class="td-btn-cancel" type="button" (click)="cancelSectionResultEdit($event)">
      Cancelar
    </button>

<button
  class="td-btn-save"
  type="button"
  (click)="saveSectionResult(section)"
>      Guardar
    </button>
  </div>
</div>


              <!-- Completar sección: SOLO si NO acepta resultados -->
              <button
                class="td-link td-link-soft"
                type="button"
                *ngIf="!section.accepts_results && !section.completed"
                (click)="onMarkCompleted(section)"
              >
                Marcar completado
              </button>
            </div>

          </article>
        </div>
      </section>

    </ng-container>

  </div>
</ion-content>
